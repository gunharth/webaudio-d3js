<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            line-height: 2em;
            margin: 20px;
        }
        * { outline: 0; }
        .grid-container-sources {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
            /* grid-template-areas: ". ."". ."". ."". ."". ."; */
            text-align: center;
        }
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
            /* grid-template-areas: ". ."". ."". ."". ."". ."; */
            text-align: center;
        }
        audio { width: 100%; }

        .recordButton {
            -moz-box-shadow:inset 0px 39px 0px -24px #e67a73;
            -webkit-box-shadow:inset 0px 39px 0px -24px #e67a73;
            box-shadow:inset 0px 39px 0px -24px #e67a73;
            background-color:#e4685d;
            border:1px solid #ffffff;
            cursor:pointer;
            color:#ffffff;
            text-decoration:none;
            text-shadow:0px 1px 0px #b23e35;
        }
        .recordButton:hover {
            background-color:#eb675e;
        }
        .recordButton:active {
            position:relative;
            top:1px;
        }

        .transformButton {
            background-color:#44c767;
            border:1px solid #18ab29;
            cursor:pointer;
            color:#ffffff;
            text-decoration:none;
            text-shadow:0px 1px 0px #2f6627;
        }
        .transformButton:hover {
            background-color:#5cbf2a;
        }
        .transformButton:active {
            position:relative;
            top:1px;
        }

        button {
            -moz-border-radius:10px;
            -webkit-border-radius:10px;
            border-radius:10px;
            padding:6px 15px;
            font-size:17px;
        }

        .col-header-4 {
            grid-column: 1 / span 4;
            text-align: left;
            padding-left: 5%;
        }

        .col-header-5 {
            grid-column: 1 / span 5;
            text-align: left;
            padding-left: 5%;
        }

    </style>
</head>

<body>

    <div class="grid-container-sources">
        <div class="col-header-4">
            <h2>1. Load a source</h2>
        </div>

        <div>
            <button class="recordButton" onclick="importAudio('piano','audio/piano.wav');">Play the piano</button>
        </div>
        <div>
            <button class="recordButton" onclick="importAudio('guni','audio/guni.ogg');">Ajax guni</button>
        </div>
        <div>
            <button class="recordButton" id="microphone-button" onclick="recordFromMicrophone();"><span class="start">Record
                    with microphone</span>
                <span class="mic-enable" style="display:none;">please enable microphone</span>
                <span class="stop" style="display:none;">(<span class="time"></span>) stop recording</span>
            </button>
        </div>
        <div>
            <div style="cursor:pointer; position:relative; overflow:hidden; display:inline-block; vertical-align:top;">
                <button class="recordButton">upload audio</button>
                <input accept="audio/*,video/*" onchange="loadAudioFile(this.files[0]);" style="cursor:pointer; z-index:5; position:absolute; top:0; left:0; bottom:0; right:0; opacity:0;"
                    type="file">
            </div>
        </div>

        <div id="recording-piano"></div>
        <div id="recording-guni"></div>
        <div id="recording-mic"></div>
        <div id="recording-upload"></div>
    </div>

    <div class="grid-container">
        <div class="col-header-5">
            <h2>2. Transform</h2>
        </div>

        <div><button class="transformButton" onclick="loadTransform(event, 'church')">Reverb</button></div>
        <div><button class="transformButton" onclick="loadTransform(event, 'autowah', 1.9)">Wah</button></div>
        <div><button class="transformButton" onclick="loadTransform(event, 'speed', 1/2)">Slow</button></div>
        <div><button class="transformButton" onclick="loadTransform(event, 'pitch', 4)">Pitch</button></div>
        <div><button class="transformButton" onclick="loadTransform(event, 'troll')">Scary</button></div>

        <div id="church"></div>
        <div id="autowah"></div>
        <div id="speed"></div>
        <div id="pitch"></div>
        <div id="troll"></div>

    </div>

        <div class="col-header-5">
            <h2>3. Visualise</h2>
        </div>







    <!-- output -->
    <section style="display:none;" class="output">
        <div class="bg"></div>

        <div class="modal">

            <div onclick="closeOutputSection()" style="position:absolute;top: 1em;right: 1em;color: white;width: 1.5em;"><img
                    style="filter:invert(100%);width: 100%;" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAF/SURBVGhD7dk7TsNAFIVhNyDRAw1iDdCxEKBiK+yAhn3w7lgGj9Ah1sACkOAc4EgjyxM745nr62h+6SiPwplPitOkqdVqtbXrCDv+e2reJnaObf2+GhERn9gXdso3DCPiAfvGHrFkjBC8EGeJCRFaMuYE4+HDi1lguhDcG7aNJcVDW2KWIXaxUVlhiiJUaYwJQpXCmCJUbswkCJULMylCjcW4QKhUjCuEWhXjEqGGYlwjVB9mFggVw5xhs0GoLkzXXCNUH2YWCMWvUxfiA5sNInZjc+EPgOuWITT3GCLusfbB+XVq3zNuMUTcYeFhOd3YXT8A7jAxxAILb2zXmKEI5RJDxC0WHoqLIZQrDBE3WHgYjogdrC8XmBjiFRuCUJNiciHUJBgirrHwQ7kXLAWhTDEbWAmEMsGURqiiGCKusPDi3DOWE6GKYKwRKjvmEgsvxj1hJREqhjnAVm4fe8esEaqNucCSE8YaoYQZhVB7WPI/RRk6/H+s1Wq1talpfgDwXHHnhZP5QwAAAABJRU5ErkJggg=="></div>

            <div class="description"></div>

            <div class="loading">
                <div class="spinner">
                    <div class="rect1"></div>
                    <div class="rect2"></div>
                    <div class="rect3"></div>
                    <div class="rect4"></div>
                    <div class="rect5"></div>
                </div>
                <p style="margin:0; color:#fff;opacity:0.6; text-align:center;">processing audio</p>
                <p style="margin:0; color:#fff;opacity:0.6; text-align:center; font-size:80%;">(this may take a little
                    while)</p>
            </div>

            <div style="display:none;" class="finished">
                <p style="margin:0; margin-bottom:0.5em; color:#fff; text-align:center;">finished!</p>
                <audio id="output-audio-tag" controls=""></audio>
                <p style="margin:0; margin-top:0.5em; color:#fff; opacity:0.6; text-align:center;">right click on the
                    play
                    button to download</p>
                <p style="margin:0; color:#fff;opacity:0.6; text-align:center; font-size:80%;">(look for "<i>Save audio
                        as...</i>" and save it as "audio<b>.wav</b>")</p>
            </div>

            <!--<div id="modalAdv" style="background:white;width: 300px;height: 250px; max-width:100%;margin: 0 auto;margin-top:1em; overflow:hidden;"></div>-->

        </div>
    </section>
    <script src="//cdnjs.cloudflare.com/ajax/libs/d3/5.7.0/d3.min.js"></script>
    <script>

        // GLOBALS
        let $ = document.querySelector.bind(document);
        // let $A = document.querySelectorAll.bind(document);
        AudioContext = window.AudioContext || window.webkitAudioContext;
        let globalAudioBuffer = null; // todo: load an example file by default (that tells them to upload their own)
        let audioURL;

        function removeAllAudioTags() {
            var element = document.getElementsByTagName("audio"), index;

            for (index = element.length - 1; index >= 0; index--) {
                element[index].parentNode.removeChild(element[index]);
            }
        }

        function appendAudioTag(id, audioURL) {
            let audio = document.createElement('audio');
            audio.controls = true;
            audio.src = audioURL;
            $('#' + id).appendChild(audio);
            audio.onplaying = function () {
                console.log(audio);
                visulize(audio);
            };
            // audio.onended = function () {
            //     cancelAnimationFrame(request)
            // };
            audio.play();
        }


        function callback(e) {
            // alert('called')
                var e = window.e || e;

                if (e.target.tagName !== 'audio')
                    return;

                alert('playing')
            }

            document.addEventListener('click', callback, false);



        async function importAudio(id, file) {

            removeAllAudioTags();

            let arrayBuffer = await (await fetch(file)).arrayBuffer();
            audioURL = URL.createObjectURL(new Blob([arrayBuffer]));

            appendAudioTag('recording-'+id, audioURL);

            let ctx = new AudioContext();
            globalAudioBuffer = await ctx.decodeAudioData(arrayBuffer);

            let source = ctx.createBufferSource();
            source.buffer = globalAudioBuffer;

            var analyser = ctx.createAnalyser();

            // Bind our analyser to the media element source.
            source.connect(analyser);
            source.connect(ctx.destination);

        }



        let maxFileSizeMegabytes = 100;
        function loadAudioFile(file) {

            removeAllAudioTags();

            if (file.size > maxFileSizeMegabytes * 1000 * 1000) {
                alert("Sorry, that file is too big. Your audio file needs to be under " + maxFileSizeMegabytes + " megabytes.");
                return;
            }

            let reader = new FileReader();
            reader.onloadend = async function () {
                let arrayBuffer = this.result;
                try {

                    audioURL = URL.createObjectURL(await new Blob([arrayBuffer]));

                    appendAudioTag('recording-upload', audioURL);

                    globalAudioBuffer = await (new AudioContext()).decodeAudioData(arrayBuffer);

                } catch (e) {
                    alert("Sorry, either that's not an audio file, or it's not an audio format that's supported by your browser. Most modern browsers support: wav, mp3, mp4, ogg, webm, flac. You should use Chrome or Firefox if you want the best audio support, and ensure you're using the *latest version* of your browser of choice. Chrome and Firefox update automatically, but you may need to completely close down the browser and potentially restart your device to 'force' it to update itself to the latest version.");
                }
            }
            reader.onerror = function (e) {
                alert("There was an error reading that file: " + JSON.stringify(e));
            }

            reader.readAsArrayBuffer(file);

        }

        // Microphone
        let currentlyRecording = false;
        let maxRecordingSeconds = 5 * 60;
        async function recordFromMicrophone() {
            removeAllAudioTags();
            if (currentlyRecording) {
                return;
            }
            currentlyRecording = true;

            // Change, button, start timer:
            var micButtonCssText = $("#microphone-button").style.cssText;
            $("#microphone-button").style.cssText = "background:#e71010; color:white;";
            $("#microphone-button .start").style.cssText = "display:none;"
            $("#microphone-button .mic-enable").style.cssText = "display:initial;"

            let chunks = [];
            let stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            let mediaRecorder = new MediaRecorder(stream, { mimeType: "video/webm" });

            mediaRecorder.start();
            let timerInterval;

            mediaRecorder.ondataavailable = function (e) { chunks.push(e.data); };
            mediaRecorder.onstart = function () {
                console.log('Started, state = ', mediaRecorder.state);

                $("#microphone-button .mic-enable").style.cssText = "display:none;";
                $("#microphone-button .stop").style.cssText = "display:initial;";

                var seconds = 0;
                $("#microphone-button .time").innerText = seconds;
                timerInterval = setInterval(() => { seconds++; $("#microphone-button .time").innerText = seconds; }, 1000);


                let stopFn = function () {
                    mediaRecorder.stop();
                    $("#microphone-button").removeEventListener("click", stopFn);
                    clearTimeout(maxLengthTimeout);
                };
                $("#microphone-button").addEventListener("click", stopFn)
                let maxLengthTimeout = setTimeout(stopFn, maxRecordingSeconds * 1000);

            };

            mediaRecorder.onerror = function (e) { console.log('Error: ', e); };
            mediaRecorder.onwarning = function (e) { console.log('Warning: ', e); };

            mediaRecorder.onstop = async function () {
                console.log('Stopped, state = ' + mediaRecorder.state);

                let blob = new Blob(chunks, { type: mediaRecorder.mimeType });//+'; codecs=opus' });//
                audioURL = URL.createObjectURL(blob);

                appendAudioTag('recording-mic', audioURL);

                let arrayBuffer = await (await fetch(audioURL)).arrayBuffer();

                try {
                    globalAudioBuffer = await (new AudioContext()).decodeAudioData(arrayBuffer);
                    // $("#audio-load-success").style.display = "flex";
                } catch (e) {
                    alert("Sorry, your browser doesn't support a crucial feature needed to allow you to record using your device's microphone. You should use Chrome or Firefox if you want the best audio support, and ensure you're using the *latest version* of your browser of choice. Chrome and Firefox update automatically, but you may need to completely close down the browser and potentially restart your device to 'force' it to update itself to the latest version.");
                }

                // Change, button, end timer:
                $("#microphone-button").style.cssText = micButtonCssText;
                $("#microphone-button .start").style.cssText = "display:initial;";
                $("#microphone-button .stop").style.cssText = "display:none;";
                clearInterval(timerInterval);

                currentlyRecording = false;

            }


        }


        async function loadTransform(e, transformName, ...transformArgs) {

            // removeAllAudioTags();

            if (currentlyRecording) {
                alert("You're currently recording a clip using your microphone. Please click the red \"stop recording\" button at the top of the page to finalize the recording, then you can click one of the voice transformers to get your transformed audio file.");
                return;
            }

            let outputAudioBuffer = await window[transformName + "Transform"](globalAudioBuffer, ...transformArgs);

            let outputWavBlob = await audioBufferToWaveBlob(outputAudioBuffer);
            audioURL = URL.createObjectURL(outputWavBlob);
            appendAudioTag(transformName, audioURL);

        }

        var frequencyData = new Uint8Array(200);
        var svgHeight = 300;
        var svgWidth = window.innerWidth;
        var barPadding = 1;
        var analyser;
        var svg = createSvg('body', svgHeight, svgWidth);

        function visulize(audioElement) {
            var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            // var audioElement = document.getElementById('audioElement');
            var audioSrc = audioCtx.createMediaElementSource(audioElement);
            analyser = audioCtx.createAnalyser();

            // Bind our analyser to the media element source.
            audioSrc.connect(analyser);
            audioSrc.connect(audioCtx.destination);




            svg.selectAll('rect')
                .data(frequencyData)
                .enter()
                .append('rect')
                .attr('x', function (d, i) {
                    return i * (svgWidth / frequencyData.length);
                })
                .attr('width', svgWidth / frequencyData.length - barPadding);

            // Run the loop
            renderChart();
        }


        function createSvg(parent, height, width) {
            return d3.select(parent)
                .append('svg')
                .attr('height', height)
                .attr('width', width);
        }

        // var graph = createSvg('#graph', svgHeight, svgWidth);


        // var dataset = [12, 19, 8, 17, 22, 9, 15, 12, 22, 25, 17, 12, 25, 16];


        // Continuously loop and update chart with frequency data.
        var request;
        function renderChart() {
            request = requestAnimationFrame(renderChart);

            // Copy frequency data to frequencyData array.
            analyser.getByteFrequencyData(frequencyData);
            // console.log(frequencyData)

            // Update d3 chart with new data.
            svg.selectAll('rect')
                .data(frequencyData)
                .attr('y', function (d) {
                    return svgHeight - d;
                })
                .attr('height', function (d) {
                    return d;
                })
                .attr('fill', function (d) {
                    return 'rgb(' + d + ', 40, 50)';
                });
        }





    </script>

    <script src="js/helpers.js"></script>
    <script src="js/doWorkerTask.js"></script>
    <script src="js/jungle.js"></script> <!-- pitch modulator lib -->
    <script src="js/troll.js"></script>
    <script src="js/speed.js"></script>
    <script src="js/pitch.js"></script>
    <script src="js/autowah.js"></script>
    <script src="js/reverb.js"></script>
</body>

</html>
